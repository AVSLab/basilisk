\documentclass[]{BasiliskReportMemo}

\usepackage{cite}
\usepackage{AVS}
\usepackage{float}
\usepackage{array}


\newcommand{\submiterInstitute}{Autonomous Vehicle Simulation (AVS) Laboratory,\\ University of Colorado}


\newcommand{\ModuleName}{SphericalHarmonics}
\newcommand{\subject}{Spherical Harmonics C++ model}
\newcommand{\status}{Tested}
\newcommand{\preparer}{M. Diaz Ramos}
\newcommand{\summary}{Spherical harmonics model and implementation is described.}


\begin{document}


\makeCover


%
%	enter the revision documentation here
%	to add more lines, copy the table entry and the \hline, and paste after the current entry.
%
\pagestyle{empty}
{\renewcommand{\arraystretch}{2}
\noindent
\begin{longtable}{|p{0.5in}|p{4.5in}|p{1.14in}|}
\hline
{\bfseries Rev}: & {\bfseries Change Description} & {\bfseries By} \\
\hline
1.0 & First version & M. Diaz Ramos \\
\hline

\end{longtable}
}

\newpage
\setcounter{page}{1}
\pagestyle{fancy}

\tableofcontents
~\\ \hrule ~\\

	\section*{Nomenclature\\}
\noindent\begin{tabular}{@{}lcl@{}}
	$\alpha$ &=& angle from $\bar{\mathbf{r}}$ to $\bar{\mathbf{r}}_{\text{Q}}$   \\
	$C_{l,m}, S_{l,m}$ &=& Integration coefficients \\
	$\delta_{m}$ &=& the Kronecker delta \\
	$\mathrm{d}m_{\text{Q}}$  &=&  differential mass element of celestial body Q\\
	$G$ &=& universal gravitational constant\\
	$\gamma$ &=& $\frac{|\bar{\mathbf{r}}_{\text{Q}}|}{|\bar{\mathbf{r}}|}$ \\
	$l$ &=& Legendre function degree \\
	$m$ &=& Legendre function order \\
	$\mu$ &=& gravitation parameter for the celestial body \\
	$N_{l,m}$ &=& the normalization factor \\
	$\nabla$ &=& gradient\\
	$P_l[\beta]$ &=& Legendre polynomial \\
	$(\phi_\text{Q}, \lambda_\text{Q})$ &=& (latitude, longitude) of the differental mass element \\
	$\bar{\mathbf{r}}$ &=&position vector from body center of gravity to spacecraft \\
	$\bar{\mathbf{r}}_{\text{Q}}$ &=& position vector from gravitational body center of mass to differential mass element $\mathrm{d}m_{\text{Q}}$\\
	$R_{\mathrm{ref}}^{l}$ &=& the reference radius of the gravitational body - usually the mean or maximum radius\\
	${\rho}_{\text{Q}}$  &=&  position vector from differential mass element of body Q to spacecraft\\
	${\rho}_{\text{Q}}$  &=&  position vector from differential mass element of body Q to spacecraft\\
	$U$ &=& potential gravitational energy \\
	$[X_\text{CoM}, Y_\text{CoM}, Z_\text{CoM}]$ &=& center of mass coordinates for the celestial body \\
	
	
\end{tabular} 
\pagebreak

\section{Introduction}

A spherical harmonics model and implementation is developed and described.

%\section{Document ID}
%{\tt Basilisk-SIM-subModuleTemplate}.  


\section{Mathematical model}

\subsection{Gravity models}

Gravity models are usually based on solutions of the Laplace equation ($\nabla^2 U(\mathbf{\bar r}) = 0$). It is very important to state that this equation only models a gravity potential outside a body. For computing a potential inside a body the Poisson equation is used instead.

The spherical harmonic potential is a solution of the Laplace equation using orthogonal spherical harmonics. It can be derived solving the Laplace equation in spherical coordinates, using the separation of variables technique and solving a Sturm-Liouville problem. In this work, the solution will be found using another technique, which essentially follows Vallado's book\cite{vallado2013}.

For each element of mass $d m_\text{Q}$ the potential can be written as
\begin{equation}
\D U(\mathbf{\bar r}) = G \frac{\D m_\text{Q}}{\rho_\text{Q}}
\end{equation}

where $\rho_\text{Q}$ is the distance between the element of mass and the position vector $\mathbf{\bar r}$ where the potential is computed. This position vector is usually given in a body-fixed frame. The relation between the position vector $\mathbf{\bar r}$, the position of the element of mass $\mathbf{\bar r_\text{Q}}$ and $\rho_\text{Q}$ can be given using the cosine theorem and the angle $\alpha$ between the two position vectors, as can be appreciated in Figure \ref{fig:spher_harm}.

\begin{figure}
\centering
\includegraphics[width=0.3\textwidth]{Figures/spherical_harmonics.png}
\caption{Geometry of the Spherical Harmonics Representation.}\label{fig:spher_harm}
\end{figure}

\begin{equation}
\rho_\text{Q} = \sqrt{r^2 + r_\text{Q}^2 - 2 r r_\text{Q} \cos(\alpha)} = r \sqrt{1 - 2 \frac{r_\text{Q}}{r} \cos(\alpha) + \bigg(\frac{r_\text{Q}}{r}\bigg)^2} = r \sqrt{1 - 2 \gamma \cos(\alpha) + \gamma^2}
\end{equation}
where $\gamma = r_\text{Q}/r$.

The potential can be obtained by integrating $dU$ through the whole body.
\begin{equation}
U(\mathbf{\bar r}) = G \int_{body} \frac{\D m_\text{Q}}{r \sqrt{1 - 2 \gamma \cos(\alpha) + \gamma^2}}
\end{equation}

If the potential is computed outside the body, $\gamma$ will always be less than 1, and the inverse of the square root can be approximated using the Legendre polynomials $P_l[\beta]$\cite{vallado2013}. Even though this derivation does not use the Laplace equation, it still assumes that the potential is computed outside the body.

The Legendre polynomials can be written as
\begin{equation}
P_l[\beta] = \frac{1}{2^l l!} \frac{d^l}{d \beta^l} (\beta^2 - 1)^l
\end{equation}

The potential is
\begin{equation}
U(\mathbf{\bar r}) = \frac{G}{r} \int_{body} \sum_{l=0}^\infty \gamma^l P_l[\cos(\alpha)] \D m_\text{Q}
\end{equation}

The angle $\alpha$ must be integrated. However, the cosine of the angle $\alpha$ can be decomposed using the geocentric latitude and the longitude associated to vectors $\mathbf{\bar r}$ and $\mathbf{\bar r_\text{Q}}$. These angles will be called $(\phi, \lambda)$ and $(\phi_\text{Q}, \lambda_\text{Q})$ respectively. Using the addition theorem it is possible to write\cite{vallado2013}.
\begin{equation}
P_l[cos(\alpha)] = P_l[\sin(\phi_\text{Q})] P_l[\sin(\phi)] + 2 \sum_{m=1}^l \frac{(l-m)!}{(l+m)!} (a_{l,m} a'_{l,m} + b_{l,m} b'_{l,m})
\end{equation}

where
\begin{align}
a_{l,m} &= P_{l,m}[\sin(\phi_\text{Q})] \cos(m \lambda_\text{Q})\\
b_{l,m} &= P_{l,m}[\sin(\phi_\text{Q})] \sin(m \lambda_\text{Q})\\
a'_{l,m} &= P_{l,m}[\sin(\phi)] \cos(m \lambda)\\
b'_{l,m} &= P_{l,m}[\sin(\phi)] \sin(m \lambda)
\end{align}

where $P_{l,m}[x]$ are the associated Legendre functions. "$l$" is called degree and "$m$", order. The polynomials can be computed as
\begin{equation}
P_{l,m}[\beta] = (1 - \beta^2)^\frac{m}{2} \frac{d^m}{d \beta^m} P_l[\beta]\label{eq:legendre}
\end{equation}

As can be seen, $a_{l,m}$ and $b_{l,m}$ must be integrated, but $a'_{l,m}$ and $a'_{l,m}$ can be taken outside the integral.
Therefore, it is possible to define
\begin{align}
C'_{l,m} &= \int_{body} (2 -\delta_m) r_\text{Q}^l \frac{(l-m)!}{(l+m)!} a_{l,m} \D m_\text{Q}\\
S'_{l,m} &= \int_{body} (2 -\delta_m) r_\text{Q}^l \frac{(l-m)!}{(l+m)!} b_{l,m} \D m_\text{Q}
\end{align}
where $\delta_m$ is the Kronecker delta.

Then
\begin{equation}
U(\mathbf{\bar r}) = \frac{G}{r} \sum_{l=0}^\infty C'_{l,0} \frac{P_l[\sin(\phi)]}{r^l} + \frac{G}{r} \sum_{l=0}^\infty \sum_{m=1}^l \frac{P_{l,m}[\sin(\phi)]}{r^l} \big[C'_{l,m} \cos(m \lambda) + S'_{l,m} \sin(m \lambda)]
\end{equation}

Non-dimensional coefficients $C_{l,m}$ and $S_{l,m}$ are usually used
\begin{align}
C'_{l,m} &= C_{l,m} R_{\text{ref}}^l m_\text{Q}\\
S'_{l,m} &= _\text{CoM}S_{l,m} R_{\text{ref}}^l m_\text{Q}
\end{align}
where $m_\text{Q}$ is the total mass of the body and $R_{\text{ref}}$ is a reference radius. If the coefficients $C_{l,m}$ and $S_{l,m}$ are given, the reference radius must be specified. Usually, the reference is chosen as the maximum radius or the mean radius\cite{scheeres2012}.

The potential is then
\begin{equation}
U(\mathbf{\bar r}) = \frac{\mu}{r} \sum_{l=0}^\infty C_{l,0} \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l P_l[\sin(\phi)] + \frac{\mu}{r} \sum_{l=0}^\infty \sum_{m=1}^l \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l P_{l,m}[\sin(\phi)] \big[C_{l,m} \cos(m \lambda) + S_{l,m} \sin(m \lambda)\big]
\end{equation}

Since $P_l[x] = P_{l,0}[x]$ the potential can be written in a more compact way
\begin{equation}
U(\mathbf{\bar r}) = \frac{\mu}{r} \sum_{l=0}^\infty \sum_{m=0}^l \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l P_{l,m}[\sin(\phi)] \big[C_{l,m} \cos(m \lambda) + S_{l,m} \sin(m \lambda)\big]
\end{equation}

Some coefficients have a very interesting interpretation. 
\begin{align}
C_{0,0} &= 1\\
S_{l,0} &= 0 \quad \forall l \geq 0\\
C_{1,0} &= \frac{Z_{\text{CoM}}}{R_{\text{ref}}}\\
C_{1,1} &= \frac{X_{\text{CoM}}}{R_{\text{ref}}}\\
S_{1,1} &= \frac{Y_{\text{CoM}}}{R_{\text{ref}}}
\end{align}

where $[X_\text{CoM}, Y_\text{CoM}, Z_\text{CoM}]$ represents the center of mass of the celestial body. Therefore, if the origin of the coordinate system coincides with the center of mass, all these coefficients are identically zero. Similarly, the second order coefficients are related to the second order moments (moments of inertia).

Finally, the coefficients and Legendre polynomials are usually normalized to avoid computational issues. The factor $N_{l,m}$ is called the normalization factor
\begin{equation}
N_{l,m} = \sqrt{\frac{(l-m)! (2 -\delta_m) (2 l +1)}{(l+m)!}}
\end{equation}

The normalized coefficients are
\begin{align}
\bar C_{l,m} &= \frac{C_{l,m}}{N_{l,m}}\\
\bar S_{l,m} &= \frac{S_{l,m}}{N_{l,m}}
\end{align}

The normalized associated Legendre functions are
\begin{equation}
\bar P_{l,m}[x] = P_{l,m}[x] N_{l,m}
\end{equation}

The potential may be written as
\begin{equation}
U(\mathbf{\bar r}) = \frac{\mu}{r} \sum_{l=0}^\infty \sum_{m=0}^l \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l \bar P_{l,m}[\sin(\phi)] \big[\bar C_{l,m} \cos(m \lambda) + \bar S_{l,m} \sin(m \lambda)\big]
\end{equation}

\subsection{Pines' Representation of Spherical Harmonics Gravity}

There are many ways to algorithmically compute the potential and its first and secondary derivatives. One of such algorithms is the one proposed by Pines\cite{pines1973}.

The spherical harmonics representation as it was presented has a singularity at the poles for the gravity field. The Pines' formulation avoids this problem and is more numerically stable for high degree and high order terms.

Unfortunately, this formulation does not contain the normalization factor which is necessary if the coefficients are normalized. In a paper written by Lundberg and Schutz\cite{lundberg1988}, a normalized representation of the Pines' formulation is given, but it contains an approximation.

For this work, and in order to code the spherical harmonics formulation, a formulation similar to Pines' using the Lundberg-Schutz paper will be derived. However, no approximations will be used. Therefore, the algorithm will be developed here without using the exact formulations given in those papers. For the sake of brevity, not every single derivation will be carried out, but it is possible to get the results following the expressions obtained in this section.

In the Pines' formulation the radius and the director cosines are used as coordinates. The potential will be given as $U[r, s, t, u]$, where
\begin{align}
r &= \sqrt{x^2+y^2+z^2}\\
s &= \frac{x}{r}\\
t &= \frac{y}{r}\\
u &= \frac{z}{r}
\end{align}

For a function of these coordinates, the dependance will be given using square brackets (e.g. $f[r,s,t,u]$).

Since $u = \sin(\phi) = \cos(90^\circ - \phi)$, it is possible to write
\begin{equation}
P_{l,m}[\sin(\phi)] = P_{l,m}[u]
\end{equation}

The derived Legendre functions $A_{l,m}[u]$ are defined such that
\begin{equation}
P_{l,m}[u] = (1 - u^2)^\frac{m}{2} A_{l,m}[u]
\end{equation}

From the definition of $P_{l,m}$ (Equation \refeq{eq:legendre}), it is possible to write
\begin{equation}
A_{l,m}[u] = \frac{d^m}{d u^m} P_l[u] = \frac{1}{2^l l!} \frac{d^{l+m}}{d u^{l+m}} (u^2 - 1)^l\label{eq:der_leg}
\end{equation}

The term $(1 - u^2)^\frac{m}{2}$ can be written as $(1 - \sin^2(\phi))^\frac{m}{2} = |\cos(\phi)|^m = \cos^m(\phi)$.

If the complex number $\xi$ is defined such that ($j$ is the imaginary unit)
\begin{equation}
\xi = \cos(\phi) \cos(\lambda) + j \cos(\phi) \sin(\lambda) = \frac{x}{r} + j \frac{y}{r} = s + j t
\end{equation}

it is possible to write
\begin{equation}
\xi^m = \cos^m(\phi) e^{j m \lambda} = (s + j t)^m
\end{equation}

The following sequences may be defined
\begin{align}
R_m[s,t] &= Re\{\xi^m\}\\
I_m[s,t] &= Im\{\xi^m\}
\end{align}

Putting all together, it is possible to write
\begin{equation}
U(\mathbf{\bar r}) = \frac{\mu}{r} \sum_{l=0}^\infty \sum_{m=0}^l \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l A_{l,m}[u] \{C_{l,m} R_m[s,t] + S_{l,m} I_m[s,t]\}
\end{equation}

In order to normalize the coefficients ($\bar C_{l,m}$ and $\bar S_{l,m}$) and the derived Legendre functions ($\bar A_{l,m} = N_{l,m} A_{l,m}$), each term is divided an multiplied by the normalization factor $N_{l,m}$. Then
\begin{equation}
U(\mathbf{\bar r}) = \frac{\mu}{r} \sum_{l=0}^\infty \sum_{m=0}^l \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l \bar A_{l,m}[u] \{\bar C_{l,m} R_m[s,t] + \bar S_{l,m} I_m[s,t]\}
\end{equation}

The sets $D_{l,m}[s,t]$, $E_{l,m}[s,t]$, and $F_{l,m}[s,t]$, are defined as
\begin{align}
D_{l,m}[s,t] &= \bar C_{l,m} R_m[s,t] + \bar S_{l,m} I_m[s,t]\\
E_{l,m}[s,t] &= \bar C_{l,m} R_{m-1}[s,t] + \bar S_{l,m} I_{m-1}[s,t]\\
F_{l,m}[s,t] &= \bar S_{l,m} R_{m-1}[s,t] - \bar C_{l,m} I_{m-1}[s,t]
\end{align}

The value $\rho_l[r]$ is also defined as
\begin{equation}
\rho_l[r] = \frac{\mu}{r} \bigg(\frac{R_{\text{ref}}}{r}\bigg)^l
\end{equation}

The gravity potential may be finally computed as
\begin{equation}
U(\mathbf{\bar r}) = \sum_{l=0}^\infty \sum_{m=0}^l \rho_l[r] \bar A_{l,m}[u] D_{l,m}[s,t]
\end{equation}

This is the final expression that will be used to compute the gravity potential.

\subsection{Recursion Formulas}

Several recursion formulas are needed in order to algorithmically implement the Pines' formulation. They will be given without proof, but they are easily derived using the definitions above.

\subsubsection{Recursion formula for $\rho_l[r]$}

Initial condition: $\rho_0[r] = \frac{\mu}{r}$
\begin{equation}
\rho_l[r] = \rho \cdot \rho_{l-1}[r]
\end{equation}
where $\rho = R_{\text{ref}}/r$.

\subsubsection{Recursion formula for $R_m[s,t]$}

Initial condition: $R_0[s,t] = 1$
\begin{equation}
R_m[s,t] = s R_{m-1}[s,t] - t I_{m-1}[s,t]
\end{equation}

\subsubsection{Recursion formula for $I_m[s,t]$}

Initial condition: $I_0[s,t] = 0$
\begin{equation}
I_m[s,t] = s I_{m-1}[s,t] + t R_{m-1}[s,t]
\end{equation}

\subsubsection{Recursion formula for $\bar A_{l,m}[u]$}

From Equation \eqref{eq:der_leg}, it is possible to see that
\begin{align}
A_{l,l}[u] &= (2 l -1) A_{l-1,l-1}[u]\label{eq:All}\\
A_{l,l-1}[u] &= u A_{l,l}[u]\label{eq:All_1}
\end{align}

There are several recursion formulas for computing Legendre polynomials $A_{l,m}[u]$, for $m < l-1$. The following formula, which is stable for high degrees\cite{lundberg1988}, will be used:
\begin{equation}
A_{l,m}[u] = \frac{1}{l-m} ((2 l -1) u A_{l-1,m}[u] - (l+m-1) A_{l-2,m}[u])\label{eq:Alm}
\end{equation}

Using Equations \eqref{eq:All}, \eqref{eq:All_1}, and \eqref{eq:Alm}, and the definition $\bar A_{l,m}[u] = N_{l,m} A_{l,m}[u]$, the following recursion formulas can be derived.

Initial condition: $\bar A_{0,0}[u] = 1$

The diagonal terms are computed as
\begin{equation}
\bar A_{l,l}[u] = \sqrt{\frac{(2 l - 1) (2 - \delta_l)}{(2 l) (2 - \delta_{l-1})}} \bar A_{l-1,l-1}[u]
\end{equation}

The low diagonal terms are then calculated as
\begin{equation}
\bar A_{l,l-1}[u] = u \sqrt{\frac{(2 l) (2 - \delta_{l-1})}{2 - \delta_l}} \bar A_{l,l}[u]
\end{equation}

Finally, for $l \geq (m+2)$, $N1_{l,m}$ and $N2_{l,m}$ are defined such that
\begin{align}
N1_{l,m} &= \sqrt{\frac{(2 l + 1) (2 l - 1)}{(l - m) (l + m)}}\\
N2_{l,m} &= \sqrt{\frac{(l + m - 1) (2 l + 1) (l - m -1)}{(l - m) (l + m) (2 l - 3)}}
\end{align}

and $\bar A_{l,m}[u]$ computed using

\begin{equation}
\bar A_{l,m}[u] = u N1_{l,m} \bar A_{l-1,m}[u] - N2_{l,m} \bar A_{l-2,m}[u]
\end{equation}


\subsection{Derivatives}

The first order derivatives of many of the values given are necessary to compute the gravity field (second order derivatives are needed if the Hessian is to be computed).

It is easy to show that
\begin{align}
\frac{\partial D_{l,m}}{\partial s}[s,t] &= m E_{l,m}[s,t]\\
\frac{\partial D_{l,m}}{\partial t}[s,t] &= m F_{l,m}[s,t]
\end{align}

\begin{equation}
\frac{d \rho_l}{d r}[r] = -\frac{(l+1)}{R_{\text{ref}}} \rho_{l+1}[r]
\end{equation}

\begin{align}
\frac{\partial R_m}{\partial s}[s,t] &= m R_{m-1}[s,t]\\
\frac{\partial R_m}{\partial t}[s,t] &= -m I_{m-1}[s,t]\\
\frac{\partial I_m}{\partial s}[s,t] &= m I_{m-1}[s,t]\\
\frac{\partial I_m}{\partial t}[s,t] &= m R_{m-1}[s,t]
\end{align}

\begin{equation}
\frac{d \bar A_{l,m}}{d u}[u] = \frac{N_{l,m}}{N_{l,m+1}} \bar A_{l,m+1}[u]
\end{equation}

The gravity field can be computed using all the equations given. However, the gradient of the potential is needed. As a change of variables was realized, the chain rule must be applied. In order to avoid filling up pages with math derivations, the results will be given. With patience, the following results can be obtained applying the chain rule and using all the derivatives given.

The gravity field can be computed as
\begin{equation}
\mathbf{\bar g} = (a_1[r,s,t,u] + s \cdot a_4[r,s,t,u]) \mathbf{\hat i} + (a_2[r,s,t,u] + t \cdot a_4[r,s,t,u]) \mathbf{\hat j} + (a_3[r,s,t,u] + u \cdot a_4[r,s,t,u]) \mathbf{\hat k}
\end{equation}

where
\begin{align}
a_1[r,s,t,u] &= \sum_{l=0}^\infty \sum_{m=0}^l \frac{\rho_{l+1}[r]}{R_{\text{ref}}} m \bar A_{l,m}[u] E_{l,m}[s,t]\\
a_2[r,s,t,u] &= \sum_{l=0}^\infty \sum_{m=0}^l \frac{\rho_{l+1}[r]}{R_{\text{ref}}} m \bar A_{l,m}[u] F_{l,m}[s,t]\\
a_3[r,s,t,u] &= \sum_{l=0}^\infty \sum_{m=0}^l \frac{\rho_{l+1}[r]}{R_{\text{ref}}} m \frac{N_{l,m}}{N_{l,m+1}} \bar A_{l,m+1}[u] D_{l,m}[s,t]\\
a_4[r,s,t,u] &= \sum_{l=0}^\infty \sum_{m=0}^l \frac{\rho_{l+1}[r]}{R_{\text{ref}}} m \frac{N_{l,m}}{N_{l+1,m+1}} \bar A_{l+1,m+1}[u] D_{l,m}[s,t]
\end{align}

In order to avoid computing factorials, it is easy to see that
\begin{align}
\frac{N_{l,m}}{N_{l,m+1}} &= \sqrt{\frac{(l-m) (2-\delta_m)(l+m+1)}{2- \delta_{m+1}}}\\
\frac{N_{l,m}}{N_{l+1,m+1}} &= \sqrt{\frac{(l+m+2)(l+m+1)(2l+1)(2-\delta_m)}{(2l+3)(2-\delta_{m+1})}}
\end{align}

Using all these expressions, the potential and the gravity field can be computed.

\clearpage

\section{Variable Definition and Code Description}
The variables in Table \ref{tabular:vars} are available for user input. Variables used by the module but not available to the user are not mentioned here. Variables with default settings do not necessarily need to be changed by the user, but may be.
	\begin{table}[H]
		\caption{Definition and Explanation of Variables Used.}
		\label{tab:errortol}
		\centering \fontsize{10}{10}\selectfont
		\begin{tabular}{ | m{3cm}| m{3cm} | m{3cm} | m{6cm} |} % Column formatting, 
			\hline
			\textbf{Variable}   							& \textbf{LaTeX Equivalent} 	&		\textbf{Variable Type} & \textbf{Notes}			  \\ \hline
			spherHarm.maxDeg					&$l_{\text{max}}$		 	  & double & Default setting: 0"inertial\_state number of degree to use when calculating gravity effects using sperical harmonics.\\ \hline
			radEquator			   & $R_{\mathrm{ref}}^{l}$			& double & [m] Default setting: 0.0. 	This is the reference radius of the gravity body.\\ \hline
			muBody					& $\mu$ 		& double & [m3/s2] Default setting: 0.0f. This is the gravitational parameter of the body. Required Input to get any non-zero values out of the code.\\ \hline
			isCentralBody & N/A & bool & Default setting: False. Determines whether the body in question is the central (inertial) body.\\ \hline
			isDisplayBody & N/A & bool & Default setting: False. Determines whether the body in question is the focus of the visualization\\ \hline
			ephemTime & N/A & double & [s] Default setting: 0. The ephemeris time for the body in question \\ \hline
			ephIntTime & N/A & double & [s] Default setting: 0. Required Input. The integration time asociated with the ephem data. \\ \hline
			bodyInMsgName & N/A & string & Required Input. The name of the message with body data in the body frame. \\ \hline
			outputMsgName & N/A & string & Required Input. The name of the message containing ephemeris information in display frame \\ \hline
			planetEphemNae & N/A & string & Required Input. An ephemeris name for the planet (user-named). \\ \hline
		\end{tabular}
		\label{tabular:vars}
	\end{table}

\subsection{Code Diagram}

\begin{figure}[H]
	\centering \includegraphics[height=0.8\textwidth, keepaspectratio]{Figures/codeFlow.pdf}
	\caption{A pseudo-code diagram demonstrating the flow of inputs and outputs in the gravity effector module.}
	\label{img:codeFlow}
\end{figure}

The diagram in Fig. \ref{img:codeFlow} demonstrates the basic iterative logic of the gravity effector module. There is extensive additional code that deals with things from the messaging system to transforming the spacecraft position from one frame to another. In general, the inputs shown must be given for each gravity body to be considered. There are, however, convenience functions which add the standard values of these inputs for common celestial bodies. An example is simIncludeGravity.addEarth() in the test\_scenarioOrbitManeuver.py tutorial.

After the inputs are given for each gravity body, the computeGravityInertial() calculates the $0^{\textbf{th}}$ degree gravity term for each body and its effects on the spacecraft. If useSphericalHarmParams is True for a given body, then computeField() is called to calculate higher degree spherical harmonics terms for that body.

\section{Library}

The library is structured around the class \textit{sphericalHarmonics}, which computes the gravity field, and a family of classes which inherit from \textit{coeffLoader} that load the coefficients from any source. The abstract class \textit{coeffLoader} can be inherited if coefficient files with new formats are found.

A class diagram of the library can be seen in Figure \ref{fig:class}. Figure \ref{fig:use_case} shows a use case diagram. In the typical use case, the user creates a \textit{coeffLoader} object, and assigns it to the \textit{sphericalHarmonics} object when its constructor is called. The class automatically loads the coefficients using \textit{coeffLoader}'s \textit{load()} interface and pre-computes all those values that are independent of the coordinates. The user then calls \textit{computeField()} method to calculate the gravity field at a given planet-fixed position.

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{Figures/class_diagram.pdf}
\caption{UML class diagram.}\label{fig:class}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.7\textwidth]{Figures/usecase_diagram.pdf}
\caption{UML use case diagram.}\label{fig:use_case}
\end{figure}

\section{Unit Test}
The unit test, \testname  validates the internal aspects of the Basilisk spherical harmonics gravity effector module by comparing module output to expected output. It utilizes spherical harmonics for calulcation given the gravitation parameter for the massive body, a reference radius, and the maximum degree of spherical harmonics to be used. The unit test verifies basic set-up, single-body gravitational acceleration, and multi-body gravitational acceleration.

\subsection{Test Description}
This test is located in {\tt SimCode/dynamics/gravityEffector/\_UnitTest/\testname}. In order to get good coverage of all the aspects of the module, the test is broken up into three sub-tests: \par
\subsubsection{Model Set-Up Verification}
This test verifies, via three checks, that the model is appropriately initialized when called.
		\begin{itemize}
			\item \underline{1.1} The first check verifies that the normalized coefficient matrix for the spherical harmonics calculations is initialized appropriately as a $3\times3$ identity matrix. \\
			\item \underline{1.2} The second check verifies that the magnitude of the gravity being calculated is reasonable(i.e. between $9.7$ and $9.9$ $m/s^2$). \\
			\item \underline{1.3} The final check ensures that the maximum degrees value is truly acting as a ceiling on the maximum number of degrees being used in the spherical harmonics algorithms. For example, if the maximum degrees value is set to 20, an attempt is made to call the spherical harmonics algorithms with a degrees value of 100 and another attempt is made with a degrees value of 20. The results are compared and should be equal due to the enforcement of the maximum degrees value.\\
		\end{itemize}
\subsubsection{Single-Body Gravity Calculations} This test compares calculated gravity values around the Earth with ephemeris data from the Hubble telescope. The simulation begins shortly after 0200 UTC May 1, 2012 and carries on for two hours, evaluating the gravitational acceleration at two  second intervals.
\subsubsection{Multi-Body Gravity Calculations} This test includes gravity effects from Earth, Mars, Jupiter, and the Sun. Calculations are verified by comparing against ephemeris data from the DAWN mission. The simulation begins at midnight, October 24th, 2008 and carries on for just under 22 minutes, evaluating the gravitational acceleration at two second intervals.

\subsection{Test Parameters}

This section summarizes the  specific error tolerances for each test. Error tolerances are determined based on whether the test results comparison should be exact or approximate due to integration or other reasons. Error tolerances for each test are summarized in table \ref{tab:errortol}. \\
	
	\begin{table}[htbp]
		\caption{Error tolerance for each test.}
		\label{tab:errortol}
		\centering \fontsize{10}{10}\selectfont
		\begin{tabular}{ c | c } % Column formatting, 
			\hline
			\textbf{Test}   							    & \textbf{Tolerated Error} 						  \\ \hline
			Gravity Magnitude (check 1.2)        & \input{AutoTex/sphericalHarmonicsAccuracy}		   \\ \hline
			Single-Body Gravity						   & \input{AutoTex/singleBodyAccuracy}														   \\ \hline
			Multi-Body Gravity 						   & \input{AutoTex/multiBodyAccuracy}	 		       \\ \hline
		\end{tabular}
	\end{table}


\subsection{Test Results}

All checks within \testname passed as expected. Table \ref{tab:results} shows the test results.\\

\begin{table}[htbp]
	\caption{Test results.}
	\label{tab:results}
	\centering \fontsize{10}{10}\selectfont
	\begin{tabular}{c | c | c  } % Column formatting, 
		\hline
		\textbf{Test} 				    & \textbf{Pass/Fail} 						   			           & \textbf{Notes} 									\\ \hline
		Setup Test 		   			  	& \input{AutoTex/sphericalHarmonicsPassFail}     & \input{AutoTex/sphericalHarmonicsFailMsg}			 \\ \hline
		Single-Body Gravity		   	& \input{AutoTex/singleBodyPassFail}                 & \input{AutoTex/singleBodyFailMsg} \\ \hline
		Multi-Body Gravity			 &\input{AutoTex/multiBodyPassFail}  			 	 &  \input{AutoTex/multiBodyFailMsg} 			   \\ \hline
	\end{tabular}
\end{table}

\subsection{Test Coverage}
This test covers 2000\% of the code.
\section{Conclusion}
What a great piece of code.

\bibliography{bibliography}{}
\bibliographystyle{plain}


\end{document}
