[build-system]
build-backend = "setuptools.build_meta"
requires = [
    "setuptools>=70.1.0,<=78.1.0",   # Required for "bdist_wheel" to work correctly.
    "setuptools-scm>=8.0,<=8.2.1",  # Automatically include all Git-controlled files in sdist
    "packaging",
    "numpy>=1.24.4,<2.4.0",

    # Requirements for building Basilisk through conanfile
    "conan>=2.0.5,<=2.15.1",
    "cmake>=3.26,<4.0",
    "swig>=4.2.1"  # Known to work with https://github.com/nightlark/swig-pypi/pull/120
]

[project]
name        = 'bsk'
dynamic     = ["version", "dependencies"]
requires-python = ">=3.8, <3.14"

readme      = "README.md"
license     = {file = "LICENSE"}
description = "Basilisk: an Astrodynamics Simulation Framework"

[project.urls]
homepage = 'https://avslab.github.io/basilisk/'
source = "https://github.com/AVSLab/basilisk"
tracker = "https://github.com/AVSLab/basilisk/issues"

# Define console scripts here
[project.scripts]
bskLargeData = "Basilisk.utilities.bskLargeData:main"
bskExamples = "Basilisk.utilities.bskExamples:main"

[tool.setuptools]
packages = []  # XXX: Leave blank, populated automatically by setup.py.
include-package-data = true

[tool.setuptools.package-data]
"*" = ["*.so", "*.dll", "*.lib", "*.pyd", "*.a", "*.dylib"]  # Include all built objects.
Basilisk = [
    "supportData/AlbedoData/*",
    "supportData/AtmosphereData/*",
    "supportData/DentonGEO/*",
    "supportData/EphemerisData/*.tpc",
    "supportData/EphemerisData/*.dat",
    "supportData/EphemerisData/*.tls",
    "supportData/EphemerisData/*.tsc",
    "supportData/LocalGravData/*",
    "supportData/MagneticField/*"
]

[tool.setuptools.dynamic]
version = {file = "docs/source/bskVersion.txt"}
dependencies = {file = "requirements.txt"}

[project.optional-dependencies]
test = [
  "numpy<2",
  "psutil",
  "pytest-error-for-skips",
  "pytest",
]

[tool.cibuildwheel]
build = ["cp38-*", "cp39-*", "cp310-*", "cp311-*", "cp312-*", "cp313-*"]
skip  = ["*-win32", "cp38-macosx_arm64", "*-musllinux_*"]
build-verbosity = 1
test-extras = ["test"]
test-command = "bskLargeData && pytest -v {project}/src/tests -m \"not ciSkip and not scenarioTest and not viz\""

[tool.cibuildwheel.windows]
before-build = "pip install delvewheel"
repair-wheel-command = """
cmd /d /c ^
  echo === PROBE begin === && ^
  echo CWD: && cd && ^
  echo --- DLLs under project --- && dir /s /b {project}\\*.dll 2^>nul && ^
  echo --- DLLs under common build dirs --- && ^
    dir /s /b {project}\\build\\*.dll 2^>nul && ^
    dir /s /b {project}\\out\\*.dll 2^>nul && ^
    dir /s /b {project}\\dist3\\*.dll 2^>nul && ^
  echo === Running delvewheel === && ^
  python -m delvewheel repair -v -w {dest_dir} --add-path {project}\\build\\bin;{project}\\dist3\\Basilisk {wheel}
"""

[tool.cibuildwheel.environment]
CMAKE_BUILD_TYPE = "Release"

[tool.cibuildwheel.macos.environment]
MACOSX_DEPLOYMENT_TARGET = "11.0"
CMAKE_OSX_DEPLOYMENT_TARGET = "11.0"

[tool.cibuildwheel.linux]
archs = ["native"]
repair-wheel-command = [
  "auditwheel repair --strip -w {dest_dir} {wheel}"
]
manylinux-x86_64-image  = "manylinux_2_28"
manylinux-aarch64-image = "manylinux_2_28"
