name: "Pull Request Closed"

on:
    pull_request:
        types:
            - closed
        branches:
            - develop
    workflow_dispatch:

jobs:
    if_merged:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        steps:
        - name: Pull repo
          uses: actions/checkout@v4
          with:
            ref: develop
            fetch-depth: 0
            token: ${{ secrets.BOT_ACCESS_TOKEN }}
        - name: Bump version
          run: ./.github/workflows/version-bumper.sh ./docs/source/bskVersion.txt
        - name: Commit and push
          run: |
              git config user.name "AVSlabBot"
              git config user.email "cuavslab@gmail.com"
              git commit -a -m "[AUTO] Bump version number"
              git push

    build_documentation:
      name: macOS Docs Deployment
      runs-on: macos-14
      strategy:
        matrix:
          python-version: [ "3.11" ]
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Set up Python ${{ matrix.python-version }}
          uses: actions/setup-python@v5
          with:
            python-version: ${{ matrix.python-version }}

        - name: Install Homebrew
          run: |
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            brew install swig doxygen

        - name: "Create virtual Environment"
          run: python3 -m venv .venv
        - name: "Install wheel and conan package"
          run: |
            source .venv/bin/activate
            pip3 install wheel 'conan<2.0' cmake

        - name: "Build basilisk with OpNav"
          run: source .venv/bin/activate && python3 conanfile.py --opNav True --allOptPkg

        - name: "Run Python Tests"
          run: |
            source .venv/bin/activate
            cd src
            pytest -n auto -m "not ciSkip"

        - name: "Build Documentation"
          run: |
            source .venv/bin/activate
            cd docs
            make html SPHINXOPTS="-W"
          if: ${{ always() }}
