name: "Pull Request"

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pre-commit

  build-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    needs: pre-commit
    strategy:
      fail-fast: false
      matrix:
        python: ["3.13"]
    name: Linux (${{ matrix.python }})
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build
        with:
          python-version: ${{ matrix.python }}
          conan-args: --opNav True --mujoco True --mujocoReplay True --recorderPropertyRollback True
      - name: Pytest
        working-directory: src
        run: |
          pip install pytest-error-for-skips
          pytest -n auto -m "not ciSkip" -rs --error-for-skips --dist=loadscope -v
      - name: CTest
        if: ${{ always() }}
        working-directory: dist3
        run: ctest

  build-windows:
    runs-on: windows-2025
    timeout-minutes: 90
    needs: pre-commit
    strategy:
      fail-fast: false
      matrix:
        python: ["3.13"]
    name: Windows (${{ matrix.python }})
    env:
      MPLBACKEND: agg
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build
        with:
          python-version: ${{ matrix.python }}
          conan-args: --opNav True --mujoco True --mujocoReplay True --recorderPropertyRollback True
      - name: Pytest
        shell: pwsh
        working-directory: src
        run: |
          pip install pytest-error-for-skips
          pytest -n auto -m "not ciSkip" -rs --error-for-skips --dist=loadscope -v
          if(($LastExitCode -ne 0) -and ($LastExitCode -ne 5)) {exit 1}
      - name: CTest
        if: ${{ always() }}
        shell: pwsh
        working-directory: dist3
        run: |
          ctest
          if(($LastExitCode -ne 0) -and ($LastExitCode -ne 5)) { exit 1 }

  build-macos:
    runs-on: macos-latest
    timeout-minutes: 90
    needs: pre-commit
    strategy:
      fail-fast: false
      matrix:
        job_suffix: [""]
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
        pytest_flags:
          ['-n auto -m "not ciSkip" -rs --error-for-skips --dist=loadscope -v']
        conan_args:
          [
            "--opNav True --mujoco True --mujocoReplay True --recorderPropertyRollback True",
          ]
        include:
          # An extra Basilisk build to test building without visualization enabled
          - python: "3.13"
            pytest_flags: -n auto -m "not ciSkip" -rs --dist=loadscope -v
            conan_args: --opNav True --mujoco True --mujocoReplay True --recorderPropertyRollback True --vizInterface False
            job_suffix: "--vizInterface False"
          # Python 3.8 cannot run all tests.
          # TODO: Once Python 3.8 support is dropped, delete this include and exclude and remove 3.8 from the python
          # test matrix.
          - python: "3.8"
            pytest_flags: -n auto -m "not ciSkip" -rs --dist=loadscope -v -p no:pytest_forbid_skips
        exclude:
          - python: "3.8"
            pytest_flags: '-n auto -m "not ciSkip" -rs --error-for-skips --dist=loadscope -v'

    name: macOS (${{ matrix.python }}) ${{ matrix.job_suffix }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build
        with:
          python-version: ${{ matrix.python }}
          conan-args: ${{ matrix.conan_args }}
      - name: Pytest
        working-directory: src
        run: |
          pip install pytest-error-for-skips
          pytest ${{ matrix.pytest_flags }}
      - name: CTest
        if: ${{ always() }}
        working-directory: dist3
        run: ctest -C Release

  docs:
    needs: build-macos
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Basilisk
        uses: ./.github/actions/build
        with:
          python-version: 3.13
          conan-args: --opNav True --allOptPkg --mujoco True --mujocoReplay True --recorderPropertyRollback True
      - name: Build docs
        uses: ./.github/actions/docs
